# 智能個人資料設定功能

## 概述

本 LINE Bot 支援**兩種方式**設定個人資料：

1. **一次性智能輸入**（快速）- 使用 Gemini AI 自動解析完整資料
2. **逐步問答**（傳統）- 透過 7 個問題逐步收集資料

## 🚀 一次性智能輸入（新功能）

### 使用方式

當系統詢問「請問我該如何稱呼您？」時，您可以**直接一次輸入所有資料**，AI 會自動辨識並填入。

### 輸入範例

#### 範例 1：完整資料
```
曾先生，75歲，國小，第二型糖尿病，有糖尿病的心臟和腎臟的併發症，目前使用胰島素治療
```

**系統回應：**
```
✅ 太好了！我已經成功辨識您的資料！

【您的個人資料】
• 稱呼：曾先生
• 年齡：75歲
• 性別：男性
• 糖尿病類型：第2型
• 併發症：心血管疾病, 腎臟病變
• 教育程度：國小
• 目前用藥：胰島素

現在我會根據您的個人資料提供更適合您的衛教建議！
```

#### 範例 2：簡潔格式
```
王小姐 32歲 女 第1型 無併發症 研究所畢業 長效胰島素
```

#### 範例 3：自然語言
```
我叫李先生，今年50歲，男性，患有第2型糖尿病，高中畢業，目前服用Metformin
```

### 支援的格式

系統**非常靈活**，支援多種輸入格式：

- ✅ 逗號分隔：`曾先生，75歲，國小，第2型`
- ✅ 空格分隔：`王小姐 32歲 女 第1型`
- ✅ 自然語言：`我叫李先生，今年50歲，患有第2型糖尿病`
- ✅ 混合格式：`曾先生 75歲，第二型糖尿病 國小畢業`

### 智能辨識能力

系統會自動辨識以下資訊：

| 欄位 | 辨識關鍵字 | 範例 |
|------|-----------|------|
| **稱呼** | 先生、小姐、媽媽、姓名 | 曾先生、王小姐、李媽媽 |
| **年齡** | 數字 + 歲 | 75歲、32歲、50 |
| **性別** | 男/女/男性/女性 | 男性、女 |
| **糖尿病類型** | 第1型、第2型、妊娠 | 第二型、第1型、妊娠糖尿病 |
| **併發症** | 心臟、腎臟、眼睛、神經、足部 | 心臟和腎臟併發症 |
| **教育程度** | 國小、國中、高中、大學、研究所 | 國小、大學畢業 |
| **用藥** | 藥物名稱 | 胰島素、Metformin |

### 併發症智能映射

系統會自動將口語化描述轉換為標準術語：

| 您的輸入 | 系統辨識為 |
|---------|-----------|
| 心臟 | 心血管疾病 |
| 腎臟 | 腎臟病變 |
| 眼睛、視力 | 視網膜病變 |
| 神經 | 神經病變 |
| 足部、腳 | 足部病變 |

### 性別自動識別

- 稱呼包含「先生」→ 自動設定為「男性」
- 稱呼包含「小姐、媽媽、女士」→ 自動設定為「女性」
- 明確輸入「男/女/男性/女性」→ 直接使用

### 觸發條件

系統會在以下情況嘗試智能解析：

1. 輸入長度 > 20 字元
2. 包含逗號（`,` 或 `，`）
3. 包含「歲」字

如果不符合條件，會按照傳統逐步問答流程。

## 📋 逐步問答（傳統方式）

如果您偏好傳統方式，只需在第一個問題時**只輸入稱呼**，系統會自動進入逐步問答模式。

### 問答流程

1. **稱呼**：王先生、小美、張媽媽
2. **年齡**：45
3. **性別**：男性 或 女性
4. **糖尿病類型**：1/2/3/4
5. **併發症**：1,3 或 6（無）
6. **教育程度**：1/2/3/4/5
7. **目前用藥**：Metformin, 胰島素 或 無

## 🔧 技術實現

### AI 解析引擎

- 使用 **Gemini 2.5 Flash** 模型
- 低溫度（0.1）確保精確解析
- JSON 格式結構化輸出
- 自動清理 Markdown 代碼塊

### 資料驗證

- 至少需包含 **3 個欄位**才會接受智能解析
- 缺失欄位會標記為「未提供」
- 所有資料自動儲存到 `data/user_profiles.json`

### 錯誤處理

如果智能解析失敗（例如輸入過於模糊），系統會：
1. 將輸入視為「稱呼」
2. 自動進入逐步問答模式
3. 繼續詢問下一個問題

## 💡 使用建議

### 推薦使用一次性輸入的情況

- ✅ 您已準備好完整資料
- ✅ 想要快速完成設定
- ✅ 資料格式清楚（逗號或空格分隔）

### 推薦使用逐步問答的情況

- ✅ 不確定要輸入哪些資料
- ✅ 偏好系統引導
- ✅ 想要慢慢填寫

## 📊 比較

| 特點 | 一次性智能輸入 | 逐步問答 |
|------|--------------|---------|
| **速度** | ⚡ 極快（1 次） | 🐢 較慢（7 次） |
| **靈活性** | 🎨 高（自由格式） | 📋 低（固定格式） |
| **準確性** | 🤖 AI 辨識 | ✅ 100% 準確 |
| **易用性** | 💡 需知道格式 | 👶 新手友善 |
| **錯誤處理** | ⚠️ 可能需重試 | ✅ 逐步驗證 |

## 🎯 實際使用範例

### 場景 1：醫院志工協助設定

志工：「請把資料告訴我」
患者：「我叫曾先生，75歲，國小畢業，第二型糖尿病，有心臟和腎臟的併發症，現在打胰島素」

→ 志工直接輸入，AI 自動辨識，設定完成！

### 場景 2：自己慢慢填寫

系統：「請問我該如何稱呼您？」
使用者：「王先生」

系統：「很高興認識您，王先生！請問您的年齡是？」
使用者：「45」

→ 逐步完成，確保每個欄位都正確

### 場景 3：部分資料輸入

使用者：「李小姐，28歲，第1型糖尿病」

系統：
```
✅ 太好了！我已經成功辨識您的資料！

【您的個人資料】
• 稱呼：李小姐
• 年齡：28歲
• 性別：女性
• 糖尿病類型：第1型
• 併發症：未提供
• 教育程度：未提供
• 目前用藥：未提供
```

→ 部分辨識也可以！之後可用「更新資料」補充

## ⚙️ 系統日誌

管理員可從日誌查看解析過程：

```
🔍 Attempting to parse complete profile from: 曾先生，75歲，國小，第二型糖尿病，有心臟和腎臟併發症，使用胰島素
✅ Successfully parsed profile: {'name': '曾先生', 'age': '75', 'gender': '男性', 'diabetes_type': '第2型', 'complications': ['心血管疾病', '腎臟病變'], 'education_level': '國小', 'current_medications': ['胰島素']}
💾 Saved 1 user profiles to data/user_profiles.json
```

## 🔄 修改資料

無論使用哪種方式設定，都可隨時輸入「更新資料」重新設定。
